# Session Log — 2026-02-27

## Summary

Long investigation and infrastructure session covering skills system internals, agent loop tracing, edit tool failures, auth store architecture, and API key injection via Docker env vars.

## Work Done

### 1. Skills System Deep Dive
- Traced full skill loading flow: 6 directory sources scanned with precedence, YAML frontmatter parsing, `formatSkillsForPrompt()` generates XML index, lazy loading via `read` tool, hot reload via chokidar watchers
- Compared TOOLS.md (always in system prompt) vs SKILL.md (lazy loaded on demand)

### 2. Agent Loop Tracing
- Traced `runLoop()` cycle: `streamAssistantResponse()` → tool call detection → `executeToolCalls()` → push results → repeat
- Explained termination conditions and text delivery

### 3. book-pm MEMORY.md Edit Failures
- **Root cause:** Agent constructing `old_string` from chat output or stale system prompt, not reading file first
- Found 3 failures in session JSONL — all cases where text never existed in file
- **Fix:** Added "Edit Tool — File Editing Rules" section to VPS TOOLS.md with guardrails
- Synced to staging TOOLS.md

### 4. BookHive Reachability Issues
- Brave Search API: `SUBSCRIPTION_TOKEN_INVALID` (all agents' web search broken)
- book-pm: Anthropic key missing (grok switched it to `anthropic/claude-sonnet-4-5`)
- Cascading timeouts across BookHive agents

### 5. Auth Store Architecture & API Key Injection
- Documented auth-profiles.json structure and key resolution order
- Discovered gateway supports env var fallback (`src/agents/model-auth.ts:resolveEnvApiKey()`)
- **Resolution order:** auth-profiles.json → env vars (OPENAI_API_KEY etc.) → config apiKey

### 6. API Key Environment Variable Injection (main deliverable)
- Created `mhive-ops/.env.vps.tpl` — 1Password template for VPS `.env`
- Updated `mhive-ops/staging/.env.staging.tpl` — added API key references
- Updated `docker-compose.staging.yml` — passes API keys to container
- Updated VPS `docker-compose.override.yml` — passes API keys to container
- Ran `op inject` on VPS, generated new `.env` with OPENAI/XAI/GEMINI keys
- Fixed VPS gateway `controlUi.dangerouslyAllowHostHeaderOriginFallback` setting
- Restarted Docker — gateway healthy, all API keys visible in container

### 7. Documentation Updates
- Updated `mhive-ops/ARCHITECTURE.md` — rewrote auth store section with key resolution order, env var injection flow, and how-to-add-a-new-provider steps
- Updated Claude auto-memory with accurate auth state

## Files Created
- `mhive-ops/.env.vps.tpl` — 1Password template for VPS Docker env
- `mhive-ops/sessions/2026-02-27.md` — this session log

## Files Modified
- `mhive-ops/ARCHITECTURE.md` — auth store section rewritten
- `mhive-ops/staging/.env.staging.tpl` — added API key injection
- `docker-compose.staging.yml` — added API key env vars
- VPS `/root/.openclaw/workspace/TOOLS.md` — added edit tool guardrails
- VPS `/root/.openclaw/openclaw.json` — added controlUi fallback setting
- VPS `/root/openclaw/docker-compose.override.yml` — added API key env vars
- VPS `/root/openclaw/.env` — regenerated from template with API keys
- `~/.openclaw-staging/workspace/TOOLS.md` — synced from VPS

### 8. Anthropic + Brave Keys Added
- Both "Anthropic API Key" and "Brave API Key" added to 1Password vault by user
- Updated `.env.vps.tpl`, `.env.staging.tpl`, `docker-compose.staging.yml`, VPS `docker-compose.override.yml`
- Re-injected `.env` on VPS — now has all 5 keys: OPENAI, XAI, GEMINI, ANTHROPIC, BRAVE
- Gateway restarted and healthy with all keys visible in container

## Remaining / TODO
- **CLAUDE_AI_SESSION_KEY / CLAUDE_WEB_* vars** — not in new `.env.vps.tpl` (were in old `.env`). Add back if Claude web auth is needed
- **Maple API Key** — in 1Password but NOT in env var injection (Maple uses local proxy, key not needed as env var)
