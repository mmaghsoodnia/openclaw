# Session Log — 2026-02-27

## Summary

Long investigation and infrastructure session covering skills system internals, agent loop tracing, edit tool failures, auth store architecture, and API key injection via Docker env vars.

## Work Done

### 1. Skills System Deep Dive
- Traced full skill loading flow: 6 directory sources scanned with precedence, YAML frontmatter parsing, `formatSkillsForPrompt()` generates XML index, lazy loading via `read` tool, hot reload via chokidar watchers
- Compared TOOLS.md (always in system prompt) vs SKILL.md (lazy loaded on demand)

### 2. Agent Loop Tracing
- Traced `runLoop()` cycle: `streamAssistantResponse()` → tool call detection → `executeToolCalls()` → push results → repeat
- Explained termination conditions and text delivery

### 3. book-pm MEMORY.md Edit Failures
- **Root cause:** Agent constructing `old_string` from chat output or stale system prompt, not reading file first
- Found 3 failures in session JSONL — all cases where text never existed in file
- **Fix:** Added "Edit Tool — File Editing Rules" section to VPS TOOLS.md with guardrails
- Synced to staging TOOLS.md

### 4. BookHive Reachability Issues
- Brave Search API: `SUBSCRIPTION_TOKEN_INVALID` (all agents' web search broken)
- book-pm: Anthropic key missing (grok switched it to `anthropic/claude-sonnet-4-5`)
- Cascading timeouts across BookHive agents

### 5. Auth Store Architecture & API Key Injection
- Documented auth-profiles.json structure and key resolution order
- Discovered gateway supports env var fallback (`src/agents/model-auth.ts:resolveEnvApiKey()`)
- **Resolution order:** auth-profiles.json → env vars (OPENAI_API_KEY etc.) → config apiKey

### 6. API Key Environment Variable Injection (main deliverable)
- Created `mhive-ops/.env.vps.tpl` — 1Password template for VPS `.env`
- Updated `mhive-ops/staging/.env.staging.tpl` — added API key references
- Updated `docker-compose.staging.yml` — passes API keys to container
- Updated VPS `docker-compose.override.yml` — passes API keys to container
- Ran `op inject` on VPS, generated new `.env` with OPENAI/XAI/GEMINI keys
- Fixed VPS gateway `controlUi.dangerouslyAllowHostHeaderOriginFallback` setting
- Restarted Docker — gateway healthy, all API keys visible in container

### 7. Documentation Updates
- Updated `mhive-ops/ARCHITECTURE.md` — rewrote auth store section with key resolution order, env var injection flow, and how-to-add-a-new-provider steps
- Updated Claude auto-memory with accurate auth state


### 8. Anthropic + Brave Keys Added
- Both "Anthropic API Key" and "Brave API Key" confirmed in 1Password vault
- Updated `.env.vps.tpl`, `.env.staging.tpl`, `docker-compose.staging.yml`, VPS `docker-compose.override.yml`
- Re-injected `.env` on VPS — now has all 5 keys: OPENAI, XAI, GEMINI, ANTHROPIC, BRAVE
- Gateway restarted and healthy with all keys visible in container

### 9. Zero Hardcoded Secrets (main deliverable)
- **Cleared all 14 agents' auth-profiles.json** on VPS (backed up as `.bak`). All agents now use env var fallback.
- **Replaced hardcoded keys in VPS `openclaw.json`:** `models.providers.maple.apiKey` → `${MAPLE_API_KEY}`, `talk.apiKey` → `${ELEVENLABS_API_KEY}`
- **Added MAPLE_API_KEY and ELEVENLABS_API_KEY** to all templates (`.env.vps.tpl`, `.env.staging.tpl`) and compose files
- Re-injected `.env` on VPS — now has all 7 keys: OPENAI, XAI, GEMINI, ANTHROPIC, MAPLE, BRAVE, ELEVENLABS
- **Cleaned staging to match:** cleared all 14 staging auth-profiles.json, replaced hardcoded maple/elevenlabs keys in staging `openclaw.json` with `${VAR}` refs

### 10. Documentation Cleanup
- **ARCHITECTURE.md:** Rewrote "Secrets Management" section documenting zero-hardcoded-key model. Fixed 3 stale references in openclaw.json section (auth description, talk.apiKey description, talk.apiKey "problem" paragraph).
- **TODO.md:** Added completed "Zero hardcoded secrets" item. Updated Notes section (Docker override, secrets, security incident, Python venv).

## Commits
1. `Add API key env var injection from 1Password for VPS and staging`
2. `Add Anthropic and Brave API keys to env injection templates`
3. `Remove all hardcoded secrets — env vars only from 1Password`
4. (pending) `Clean up stale references in ARCHITECTURE.md and TODO.md`

## Files Created
- `mhive-ops/.env.vps.tpl` — 1Password template for VPS Docker env (7 secrets + config vars)
- `mhive-ops/sessions/2026-02-27.md` — this session log

## Files Modified (local repo)
- `mhive-ops/ARCHITECTURE.md` — major rewrite: secrets section, stale reference cleanup
- `mhive-ops/staging/.env.staging.tpl` — all 7 API key references
- `docker-compose.staging.yml` — all API key env vars
- `TODO.md` — completed items and notes updated

## Files Modified (VPS only)
- `/root/.openclaw/openclaw.json` — controlUi fallback, maple/elevenlabs `${VAR}` refs
- `/root/openclaw/docker-compose.override.yml` — all API key env vars
- `/root/openclaw/.env` — regenerated from template with 7 keys
- `/root/.openclaw/agents/*/agent/auth-profiles.json` (14 files) — cleared
- `/root/.openclaw/workspace/TOOLS.md` — edit tool guardrails

## Files Modified (staging only)
- `~/.openclaw-staging/workspace/TOOLS.md` — synced from VPS
- `~/.openclaw-staging/agents/*/agent/auth-profiles.json` (14 files) — cleared
- `~/.openclaw-staging/openclaw.json` — maple/elevenlabs `${VAR}` refs

## Current State
- **Zero hardcoded API keys** on both VPS and staging. All 7 provider keys injected from 1Password via Docker env vars.
- **1Password is single source of truth** for all secrets. New environments just need a service account token + `op inject`.
- **Telegram bot tokens** remain hardcoded in `openclaw.json` (low sensitivity, tracked as future work).

## Remaining / TODO
- **Telegram bot tokens** — still hardcoded in `openclaw.json`. Should eventually be templated via 1Password.
- **Edit tool guardrails plan** from previous session — VPS TOOLS.md updated, but effect on book-pm needs monitoring.
