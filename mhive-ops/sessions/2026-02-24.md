# Session Log — 2026-02-24

## Summary

Architecture review session. No infrastructure changes made. Deeply analyzed how the
OpenClaw gateway constructs context windows, verified all open TODO items are genuinely
still open, and codified the architectural understanding into permanent project documents
so future sessions don't have to re-derive it.

## What Was Done

### 1. TODO Verification (all four items confirmed open)

Checked each item against live VPS state:

- **ElevenLabs key:** `openclaw.json` last modified 2026-02-20 (before incident). Key in
  `talk.apiKey` is still the original exposed value. 1Password item was updated 2026-02-23
  but the config file was never refreshed. **Not rotated.**
- **Google OAuth:** "Google Workspace OAuth" 1Password item last edited 2026-02-21
  (day before incident). **Not rotated.**
- **Python venv:** Still alive only because container hasn't been rebuilt. Dockerfile has
  zero Python changes. Will be lost on next `docker compose up -d`. **Not fixed.**
- **WhatsApp / Voice:** `openclaw.json` channels = `["telegram"]` only. No WhatsApp or
  voice config. **Not connected.**

Also discovered: 1Password `op` CLI on VPS loses its service account token in non-login
SSH sessions (`.bashrc` not sourced). Must use single-quoted `ssh` commands that evaluate
`$(cat /root/.op-service-account-token)` on the remote side.

### 2. Deep Architecture Analysis

Traced the full context window construction through the gateway source:
- `src/agents/system-prompt.ts` — `buildAgentSystemPrompt()` builds the entire system
  prompt string
- `src/agents/workspace.ts` — loads workspace files (SOUL.md, MEMORY.md, etc.) and
  injects them verbatim under `# Project Context` in the system prompt
- Session JSONL files provide conversation history
- Tools are sent as structured JSON schema (not text in the prompt)
- Subagent/cron sessions get a stripped context (only AGENTS.md + TOOLS.md)
- Per-file limit: 20k chars; total budget: 150k chars across all workspace files

Key insight: workspace files (SOUL.md, MEMORY.md) are **part of the system prompt**, not
separate inputs. A direct edit takes effect on the very next API call — no restart needed.

Identified two distinct ownership layers:
- **Layer 1 (Operator):** openclaw.json, Dockerfile, 1Password, Python deps — edit directly
- **Layer 2 (Agent workspace):** SOUL.md, MEMORY.md, RUNBOOK.md — notify agent first

WhatsApp insight: gateway has a `whatsapp_login` agent tool. The pairing session is
written by Baileys — not a simple token. Must be initiated through the agent, not by
hand-editing openclaw.json.

### 3. Documents Created/Updated

| File | Action | Purpose |
|---|---|---|
| `mhive-ops/ARCHITECTURE.md` | Created | Full architecture reference: two-layer model, context window layers, change ownership table, WhatsApp flow, agent roster, deployment flow |
| `.claude/CLAUDE.md` | Updated | Added prominent "System Architecture — Read First" section pointing to ARCHITECTURE.md |
| `TODO.md` | Updated | Each item now tagged [Layer 1] or [Layer 2], includes verified status as of 2026-02-24, and has clear step-by-step instructions with architectural rationale |

## What Remains

All four original TODO items are open. Recommended order:

1. **Rotate secrets first** (ElevenLabs + Google OAuth) — highest security risk
2. **Fix venv persistence** — next container rebuild breaks Polymarket betting
3. **Connect WhatsApp** — via agent `whatsapp_login` tool, not manual config
4. **Enable voice** — blocked by ElevenLabs rotation; then pure operator config in openclaw.json

## Errors / Gotchas Found

- `op` CLI on VPS requires `OP_SERVICE_ACCOUNT_TOKEN` to be explicitly set in the shell.
  Non-login SSH sessions don't source `.bashrc`. Use:
  `ssh root@100.71.224.113 'OP_SERVICE_ACCOUNT_TOKEN=$(cat /root/.op-service-account-token) op ...'`
  (single quotes are required so `$()` evaluates on the remote, not locally)
