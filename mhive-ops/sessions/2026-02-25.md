# Session Log — 2026-02-25

## Summary

Two major items: **WhatsApp emergency fix** (disable channel after unsolicited messaging) and **local staging environment setup** on Mac. Also merged upstream and updated VPS.

---

## Part 1: WhatsApp Emergency Fix

### Problem

After WhatsApp was connected via `whatsapp_login`, the bot began auto-replying pairing codes to every person who messaged the linked WhatsApp number. Caused by default `dmPolicy: "pairing"` when no `channels.whatsapp` config block exists.

### Root Cause

1. WhatsApp plugin enabled (`plugins.entries.whatsapp.enabled = true`)
2. No `channels.whatsapp` config block — all defaults applied
3. Default `dmPolicy` is `"pairing"` (`access-control.ts:41`)
4. Every incoming DM triggered auto-reply with pairing code

### Fix

1. Initially set `dmPolicy: "allowlist"` with owner's number
2. User decided risk was too high — **disabled WhatsApp entirely** on VPS
3. Both plugin (`enabled: false`) and channel (`dmPolicy: "disabled"`) disabled
4. Baileys session preserved at `/root/.openclaw/credentials/whatsapp/default/`
5. 1Password item "OpenClaw WhatsApp" stores allowFrom number for future re-enablement

### Upstream Issues

- [Issue #834](https://github.com/openclaw/openclaw/issues/834) — mass messaging on reconnect (closed)
- [Issue #22599](https://github.com/openclaw/openclaw/issues/22599) — allowlist bypass via persisted pairings (open)
- [Issue #25975](https://github.com/openclaw/openclaw/issues/25975) — pairing messages in allowlist mode (open)

---

## Part 2: Local Staging Environment

### Goal

Docker-based staging on Mac that mirrors VPS — same image, same compose structure, same secrets injection — so changes can be tested locally before deploying to production.

### What Was Built

**Scripts** (`mhive-ops/staging/`):

- `start.sh` — one-command startup (sync, inject secrets, patch config, build, start)
- `stop.sh` — clean shutdown
- `rebuild.sh` — rebuild image + restart (no VPS resync)
- `sync.sh` — pull VPS state, patch config, restart
- `sync-from-vps.sh` — rsync VPS state to `~/.openclaw-staging/`
- `apply-config.sh` — inject secrets via `op run` and run `patch-config.py`
- `patch-config.py` — adapts VPS config for staging (single Telegram bot, disable WhatsApp, controlUi origins)
- `.env.staging.tpl` — 1Password inject template for secrets
- `README.md` — documentation

**Docker Compose** (`docker-compose.staging.yml`):

- Mirrors VPS `docker-compose.override.yml` with Mac paths
- maple-proxy service with health check
- gog binary mounted from `~/.openclaw-staging/bin/gog`
- Python venv bootstrap in gateway entrypoint
- Gateway binds to `lan` (0.0.0.0) inside container for Docker port mapping

**1Password Items Created**:

- "Staging Gateway Token" — random hex token for staging gateway auth
- "Staging Telegram Bot" — bot token from BotFather for `@mhive_stage_bot`

### Issues Encountered & Resolved

1. **GOG Keyring Password field name** — `.env.staging.tpl` referenced `/credential` but 1Password item uses `/password`
2. **`op inject` authorization timeout** — Touch ID required in interactive terminal, user ran manually
3. **Docker Desktop mount denied for `/opt/homebrew/bin/gog`** — Copied binary to `~/.openclaw-staging/bin/gog`
4. **`.env.staging` parsing by Docker Compose** — Comments caused issues, removed them
5. **`gateway.bind: "localhost"` invalid** — Valid values: `loopback`, `lan`, `tailnet`, `auto`, `custom`
6. **`gateway.bind: "loopback"` inside Docker** — Container loopback not reachable via port mapping; changed to `lan`
7. **Non-loopback bind requires controlUi origins** — Added `gateway.controlUi.allowedOrigins` for localhost

### Verification

- Gateway health check passes: `curl http://localhost:18789/health` ✅
- Telegram staging bot `@mhive_stage_bot` responds to messages ✅
- All containers running (gateway + maple-proxy) ✅

---

## Part 3: Upstream Merge & VPS Update

### Merge

- Merged `upstream/main` into fork (2286 commits)
- Single conflict: Dockerfile — resolved by keeping python3-pip/python3-venv install + upstream's `--chown=node:node`
- Pre-commit hook issues: needed `pnpm install` for linting, `.agents/` files unstaged (gitignored)

### VPS Update

- Pushed merged code to GitHub fork
- Pulled on VPS, rebuilt Docker image, restarted gateway
- All 3 production Telegram bots verified running: mhive, percy, bookworm
- VPS gateway health check passes ✅

---

## Files Created/Modified

| File                                 | Action                  | In Git          |
| ------------------------------------ | ----------------------- | --------------- |
| `mhive-ops/staging/start.sh`         | Created                 | Yes             |
| `mhive-ops/staging/stop.sh`          | Created                 | Yes             |
| `mhive-ops/staging/rebuild.sh`       | Created                 | Yes             |
| `mhive-ops/staging/sync.sh`          | Created                 | Yes             |
| `mhive-ops/staging/sync-from-vps.sh` | Created                 | Yes             |
| `mhive-ops/staging/apply-config.sh`  | Created                 | Yes             |
| `mhive-ops/staging/patch-config.py`  | Created                 | Yes             |
| `mhive-ops/staging/.env.staging.tpl` | Created                 | Yes             |
| `mhive-ops/staging/README.md`        | Created                 | Yes             |
| `docker-compose.staging.yml`         | Created                 | Yes             |
| `.gitignore`                         | Modified                | Yes             |
| `TODO.md`                            | Modified                | Yes             |
| `.env.staging`                       | Generated               | No (gitignored) |
| `~/.openclaw-staging/`               | Created                 | N/A (local)     |
| Dockerfile                           | Merge conflict resolved | Yes             |

## Notes

- `start.sh` requires interactive terminal for `op inject` (Touch ID) — can't be fully automated from Claude Code
- Tailscale must be off for local staging networking to work properly (or at least not interfere)
- VPS config shows "written by newer OpenClaw (2026.2.21-2); current version is 2026.2.18" — harmless version string mismatch between npm CLI and Docker-built source
