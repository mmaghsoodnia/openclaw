# Session: 2026-02-22 — Mac Setup + Full Infrastructure Buildout

**Machine:** MacBook Air 2024 (fresh, no dev tools installed)
**Operator:** mehdi + Claude Code

---

## What We Did

### 1. Mac Dev Environment (from scratch)
- Installed Homebrew, `gh` CLI, authenticated GitHub as `mmaghsoodnia`
- Cloned `mmaghsoodnia/openclaw` fork to `~/openclaw`
- Generated SSH ed25519 key and established access to VPS (`root@100.71.224.113` via Tailscale)

### 2. VPS Assessment & Fixes
- Audited running state: Docker containers, OpenClaw version, agent config, Telegram bots
- **Updated OpenClaw** from `2026.2.15` to `2026.2.21-2` (CLI + Docker image rebuilt from fork)
- **Fixed VPS git remotes** — changed `origin` from upstream to our fork (`mmaghsoodnia/openclaw`)
- **Fixed maple-proxy** — restarted container, then later corrected the health check (port 8080 → 3000) in `docker-compose.override.yml`
- **Created missing memory files** — `hive-risk` daily memory and `heartbeat-state.json`

### 3. 1Password Integration
- Installed `op` CLI on Mac (Homebrew, desktop app integration) and VPS (apt, service account)
- Migrated all secrets into 1Password vault "OpenClaw" (13 items total)
- Created a **1Password service account** for headless VPS access — token at `/root/.op-service-account-token`
- Configured `.bashrc` and `.profile` on VPS to export `OP_SERVICE_ACCOUNT_TOKEN`

### 4. Google Workspace Access (gog CLI)
- **Security audited** the `gog` CLI source code (all deps clean, no backdoors)
- **Built from source** (v0.11.0) on VPS; installed via Homebrew on Mac
- Configured **file-based keyring** (no OS keychain/biometric dependency) with `GOG_KEYRING_PASSWORD` stored in 1Password
- Completed OAuth for `mhive@bigbraincap.com` — Gmail, Calendar, Drive, Contacts, Docs, Sheets
- Enabled required Google APIs in Cloud Console (Calendar, People, Sheets, Docs)
- **Copied gog config to VPS** and mounted into Docker container via `docker-compose.override.yml`
- Verified all 6 Google services working from inside the container

### 5. Security Rules
- A security incident occurred: ElevenLabs API key and Google OAuth client_id/secret were accidentally displayed in the Claude Code conversation context (which transits Anthropic servers)
- Created strict secrets-handling rules at four levels:
  - `~/.claude/CLAUDE.md` (global, all projects)
  - `~/openclaw/.claude/CLAUDE.md` (project, checked into git)
  - `~/openclaw/TODO.md` (header section)
  - Claude Code project memory file
- **Rule:** Never read/display/pull secrets into context. Always use `op read`, `op inject`, or `op run` with direct piping.
- **Rule:** Never install pre-built binaries. Always clone source, audit, build.
- Key rotation added to TODO (user handling separately)

### 6. Operational Scripts
- **Created `deploy-vps.sh`** — Push to GitHub → pull on VPS → rebuild Docker → restart gateway. Supports `--skip-push` and `--skip-build` flags.
- **Fixed `approve-device.sh`** — Updated hardcoded IP from old public address to Tailscale IP `100.71.224.113`
- **Moved `mhive-ops` into the openclaw repo** as a subdirectory so everything lives in one git project

### 7. TODO.md System
- Created `TODO.md` at project root as a persistent cross-device task tracker
- Purpose: any machine pulling the repo gets current state of what's done and what remains
- All Claude Code sessions should read it at start, update as work progresses, and commit back

---

## Key Files Created/Modified

| File | Location | Purpose |
|------|----------|---------|
| `TODO.md` | repo root | Cross-device task tracker (read at session start) |
| `.claude/CLAUDE.md` | repo root | Project-level Claude Code rules (checked into git) |
| `mhive-ops/deploy-vps.sh` | repo | Deploy script: Mac → GitHub → VPS |
| `mhive-ops/approve-device.sh` | repo | Approve pending OpenClaw device pairings on VPS |
| `docker-compose.override.yml` | VPS only | Mounts gog binary/config, fixes maple-proxy health check |
| `.env` | VPS only | Contains `GOG_KEYRING_PASSWORD` (injected from 1Password) |
| `/root/.op-service-account-token` | VPS only | 1Password service account token (600 perms) |
| `/root/.config/gogcli/` | VPS only | gog config, credentials, and encrypted keyring |

---

## Architecture After This Session

```
Mac/Studio (dev)
  └─ ~/openclaw (fork: mmaghsoodnia/openclaw)
       ├─ git push origin main
       └─ mhive-ops/deploy-vps.sh  ───→  GitHub  ───→  VPS pulls from origin
                                                          ├─ docker build -t openclaw:local .
                                                          ├─ docker compose up -d openclaw-gateway
                                                          └─ 14 agents running (The Hive)
                                                               ├─ 3 Telegram bots (mhive, percy, bookworm)
                                                               ├─ Google Workspace via gog (6 services)
                                                               └─ Secrets from 1Password via op CLI
```

---

## Remaining After This Session

- **Rotate exposed secrets** — ElevenLabs Talk API Key + Google OAuth client secret (user handling)
